# 一、网络基础知识

## 1.ISO/OSI参考模型、五层协议和TCP/IP模型

### 1）OSI参考模型

①应用层

②表示层

③会话层

④传输层

⑤网络层

⑥数据链路层

⑦物理层

其中，高三层（①②③）统称为资源子网；低三层（⑤⑥⑦）统称为通信子网。

### 2）五层协议

①应用层

②传输层

③网络层

④数据链路层

⑤物理层

### 3）TCP/IP模型

TCP/IP模型将IP作为重要层次。

①应用层（对应OSI参考模型中的会话层、表示层、应用层）

②传输层

③网际层

④网络接口层（对应OSI参考模型中的物理层和数据链路层）

## 2.OSI参考模型中每层的作用

物理层：通过媒介传输比特,确定机械及电气规范（比特Bit）
数据链路层：将比特组装成帧和点到点的传递（帧Frame）
网络层：负责数据包从源到宿的传递和网际互连（包PackeT）
传输层：提供端到端的可靠报文传递和错误恢复（段Segment）
会话层：建立、管理和终止会话（会话协议数据单元SPDU）
表示层：对数据进行翻译、加密和压缩（表示协议数据单元PPDU）
应用层：允许访问OSI环境的手段（应用协议数据单元APDU）

## 3.电路交换、报文交换与分组交换

![image-20210310194630350](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210310194630350.png)

# 二、数据链路层

## 1.以太网的MAC帧

以太网是一种星型拓扑结构局域网。

以太网采用**无连接**的工作方式，不对发送的数据帧编号，也不要求接收方发送确认，即以太网尽最大努力交付数据，提供的是**不可靠服务**（不可靠传输即无差错接受，可靠传输即无论对错均接受），对于差错的纠正由上层完成。

数据链路层将网络层传下来的分组添加**首部 和尾部**，用于标记帧的开始和结束。

![image-20210310185825741](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210310185825741.png)

MAC地址用于识别数据链路中互连的节点，唯一标识网络适配器（网卡），一台主机拥有多少个网络适配器就有多少个 MAC 地址。**MAC地址长6B，即48bit.**

![image-20210310185254526](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210310185254526.png)

+ 前导码：使接收端与发送端时钟同步。（前导码并不是MAC帧的一部分）。

+ 地址：通常使用6B=48bit地址（MAC地址）。

+ 类型：2B，指出数据域中携带的数据应交给哪个协议实体处理。

+ FCS：校验码，算法采用32位循环冗余码，不但要检验MAC帧的数据部分，还要检验目的地址、源地址和类型字段，但不校验前导码

## 2.PPP（Point-to-Point Protocol）协议

PPP 协议是用户计算机和 ISP 进行通信时所使用的**面向字节**的数据链路层协议。

PPP协议有三个组成部分：

1）链路控制协议（LCP）：建立并维护数据链路链接，即物理连接。

2）网络控制协议（NCP）：为网络层协议建立和配置逻辑连接。

3）一个将IP数据报封装到串行链路的方法。

![image-20210310193558082](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210310193558082.png)

+ F字段：帧的定界符
+ A和C字段：内容固定，暂时没有意义
+ 协议：说明信息段中运载的是什么种类的分组（例如IP、AppleTalk等）。

​                   当协议字段值为0x0021时，表示信息字段是IP数据报。

+ FCS字段是使用CRC的检验序列

## 3.HDLC协议

高级数据链路控制（HDLC）协议是PPP 协议是用户计算机和 ISP 进行通信时所使用的数据链路层协议的数据链路层协议。

![image-20210310194400432](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210310194400432.png)

## 4.交换机

交换机具有自学习能力，学习的是交换表的内容，交换表中存储着 MAC 地址到接口的映射。正是由于这种自学习能力，因此交换机是一种即插即用设备，不需要网络管理员手动配置交换表内容。

下图中，交换机有 4 个接口，主机 A 向主机 B 发送数据帧时，交换机把主机 A 到接口 1 的映射写入交换表中。为了发送数据帧到 B，先查交换表，此时没有主机 B 的表项，那么主机 A 就发送广播帧，主机 C 和主机 D 会丢弃该帧，主机 B 回应该帧向主机 A 发送数据包时，交换机查找交换表得到主机 A 映射的接口为 1，就发送数据帧到接口 1，同时交换机添加主机 B 到接口 2 的映射。

![image-20210311190920371](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210311190920371.png)

## 5.网络互联设备的区别与联系

### （1）中继器、集线器、网桥和交换机的区别与联系

​		1.中继器工作在物理层，用来**连接两个速率相同且数据链路层协议也相同的网段**，其功能是消除数字信号在基带传输中由于经过一长段电缆而造成的失真和衰减，使信号的波形和强度达到所需的要求;其原理是信号再生。

​		2.集线器（Hub）也工作在物理层，相当于一个多接口的中继器，它可**将多个结点连接成一个共享式的局域网**，但任何时刻都**只能有一个结点通过公共信道发送数据**。

​		3.网桥工作在数据链路层，可以互联不同的物理层、不同的 MAC子层及不同速率的以太网。网桥具有过滤帧及存储转发帧的功能，可以隔离冲突域，但不能隔离广播域。

​		4.交换机工作在数据链路层，相当于一个多端口的网桥，是交换式局域网的核心设备。它允许端口之间建立多个并发连接，实现多个结点之间的并发传输。因此，**交换机的每个端口结点所占用的带宽不会因为端口结点数目的增加而减少，且整个交换机的总带宽会随着端口结点的增加而增加**。交换机一般工作在全双工方式，**有的局域网交换机采用存储转发方式进行转发，也有的交换机采用直通交换方式**(即在收到帧的同时立即按帧的目的 MAC地址决定该帧的转发端口，而不必先缓存再处理)。另外，利用交换机可以实现虚拟局域网(VLAN)，VLAN不仅可以隔离冲突域，而且可以隔离广播域。

### （2）网桥与交换机的不同之处

​		1.网桥的端口一般连接局域网，而交换机的端口一般直接与局域网的主机相连。

​		2.交换机允许多对计算机同时通信，而网桥仅允许每个网段上的计算机同时通信。

​		3.**网桥采用存储转发进行转发，而以太网交换机还可以采用直通方式进行转发**，且以太网交换机采用了专用的交换结构芯片，转发速度比网桥快。

# 三、网络层

## 1.网络层的功能

主要任务是把分组从源端传送到目的端，为分组交换网上不同的主机提供通信服务。

(1)路由选择与分组转发

(2)异构网络互联

网络互联即将两个以上的计算机网络，通过一定的方法，用一种或多种通信处理设备（即中间设备，也称中继系统）相互连接起来，以构成更大的网络系统。

根据所在的层次，中继系统分为以下4种：

①物理层中继系统：集线器，中继器。

②数据链路层中继系统：网桥或交换机。

③网络层中继系统：路由器

④网络层以上的中继系统：网关。

![image-20210311192135827](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210311192135827.png)

**冲突域：同一时间内只能有一台设备发信息的范围。**

**广播域：若站点发出一个广播信号，所有能接收到这个信号的设备的范围。**

(3)拥塞控制

## 2.IPv4

​		因为网络层是整个互联网的核心，因此应当让网络层尽可能简单。网络层向上只提供简单灵活的、**无连接的**、尽最大努力（即不做“最终收到与否的验证”）交互的数据报服务。

​		使用 IP 协议，可以把异构的物理网络连接起来，使得在网络层看起来好像是一个统一的网络。

### （1）IPv4格式

IP地址::={<网络号>,<主机号>}

![image-20210311195507572](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210311195507572.png)

+ 版本：即IP版本，目前广泛使用的版本号为4.

+ 首部长度：**占4位**。**以32bit=4B为单位**，最大值为60B（15x4B），最常用的首部长度为20B（最小值）。
+ 总长度：**占16位，单位为1B**。因此数据报的最大长度为$2^{16}-1=65535B$，包括首部长度和数据部分长度。
+ 生存时间（TTL）：占8位。它的存在是为了防止无法交付的数据报在互联网中不断兜圈子。以路由器跳数为单位，当 TTL 为 0 时就丢弃数据报。
+ 协议：指出携带的数据应该上交给哪个协议进行处理，例如ICMP、TCP、UDP等。**其中6表示TCP，17表示UDP。**

+ 首部检验和：因为数据报每经过一个路由器，都要重新计算检验和，因此检验和不包含数据部分可以减少计算的工作量。

+ 标识 : 在数据报长度过长从而发生分片的情况下，相同数据报的不同分片具有相同的标识符。

+ 片偏移 : 它指出较长的分组分片后，某片在原分组中的相对位置。**片偏移的单位为 8 字节。**

![image-20210311200610544](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210311200610544.png)





### （2）分类的IPv4地址



![image-20210311124017704](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210311124017704.png)

### （3）地址解析协议ARP

​		网络层实现主机之间的通信，而链路层实现具体每段链路之间的通信，因此在通信过程中，**IP数据报的源地址和目的地址始终不变，而MAC地址随着链路的改变而改变**。

![image-20210314095724325](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314095724325.png)

​		**地址解析协议ARP就是实现由IP地址得到MAC地址的协议。**而因为IP地址为32bit，MAC地址为48bit，不存在简单的映射关系，所以ARP解决这个问题的方法是**在主机ARP高速缓存中存放一个从IP地址到硬件地址的映射表**，并且这个表还经常动态更新。

​		**由于是IP协议使用ARP协议，所以通常把ARP协议划归网络层**。

​		如果主机 A 知道主机 B 的 IP 地址，但是 ARP 高速缓存中没有该 IP 地址到 MAC 地址的映射，此时主机 A 通过广播的方式发送 ARP 请求分组，主机 B 收到该请求后会发送 ARP 响应分组给主机 A ，并在这个ARP分组中写入自己的MAC 地址，随后主机 A 向其高速缓存中写入主机 B 的 IP 地址到 MAC 地址的映射。

​		为了减少通信量，主机A在发送其ARP请求分组时，就把自己的IP地址到MAC地址的映射写入ARP请求分组。主机B收到A的请求分组后，就把主机A的这一地址映射写入主机B自己的ARP高速缓存中。

![image-20210314101754156](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314101754156.png)

​		由图可见，ARP请求分组是广播，ARP响应分组是单播。

​		ARP是解决**同一个局域网**上的主机或路由器的IP地址和MAC地址的映射问题。

### （4）IP层转发分组的流程

- 从数据报的首部提取目的主机的 IP 地址 D，得到目的网络地址 N。

- 若 N 就是与此路由器直接相连的某个网络地址，则进行**直接交付**；

- 若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给表中所指明的下一跳路由器；

- 若路由表中有到达网络 N 的路由，则把数据报传送给路由表中所指明的下一跳路由器；

- 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；

- 报告转发分组出错。

  ​	所以可知，路由表并没有给分组指明到某个网络的完整路径，而是需要分组一步一步查找下去。

## 3.子网划分、子网掩码、CIDR

## （1）子网划分

​		**IP地址::={<网络号>,<子网号>,<主机号>}**

​		要使用子网，必须配置子网掩码。一个 B 类地址的默认子网掩码为 255.255.0.0，如果 B 类地址的子网占两个比特，那么子网掩码为 11111111 11111111 11000000 00000000，也就是 255.255.192.0。

​		注意，外部网络看不到子网的存在。

## （2）子网掩码

​		为了告诉主机或路由器对网络进行了子网划分，使用子网掩码来表达对原网络中主机位的借位。

​		在使用子网掩码的情况下:

​		1）一台主机在设置P地址信息的同时,必须设置子网掩码。

​		2）**同属于一个子网的所有主机及路由器的相应端口，必须设置相同的子网掩码。**

​		3）路由器的路由表中，所包含信息的主要内容必须有**目的网络地址、子网掩码、下一跳地址。**

​		使用子网掩码时路由器的分组转发算法如下：

​		1)   从收到的分组的首部提取目的IP地址，记为D。

​		2）先判断是否为直接交付。对路由器直接相连的网络逐个进行检查:用各网络的子网掩码和D逐位相“与”，看结果是否和相应的网络地址匹配。若匹配，则将分组直接交付，否则间接交付，执行步骤3)。

​		3）若路由表中有目的地址为D的特定主机路由，则将分组传送给路由表中所指明的下一跳路由器;否则，执行4)。

​		4)   对路由表中的每一行(目的网络地址、子网掩码、下一跳地址）中的子网掩码和D逐位相“与”，其结果为N。若N与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器;否则，执行步骤5)。

​		5）若路由表中有一个默认路由，则将分组传送给路由表中所指明的默认路由器;否则，执行步骤6)。

​		6)报告转发分组出错。

## （3）CIDR

​		无分类编址 CIDR 消除了传统 A 类、B 类和 C 类地址以及划分子网的概念，使用网络前缀和主机号来对 IP 地址进行编码，网络前缀的长度可以根据需要变化。

​		**IP 地址 ::= {< 网络前缀号 >, < 主机】**

**号 >}**

​		CIDR 的记法上采用在 IP 地址后面加上网络前缀长度的方法，例如 128.14.35.7/20 表示前 20 位为网络前缀。

​		CIDR 的地址掩码可以继续称为子网掩码，子网掩码首 1 长度为网络前缀的长度。

一个 CIDR 地址块中有很多地址，一个 CIDR 表示的网络就可以表示原来的很多个网络，并且在路由表中只需要一个路由就可以代替原来的多个路由，减少了路由表项的数量。把这种通过使用网络前缀来减少路由表项的方式称为路由聚合，也称为 **构成超网** 。

​		在路由表中的项目由“网络前缀”和“下一跳地址”组成，在查找时可能会得到不止一个匹配结果，应当采用最长前缀匹配来确定应该匹配哪一个。

​		**最长前缀匹配（最佳匹配）**:使用CIDR时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。在查找路由表时可能会得到不止--个匹配结果。此时，应当从匹配结果中选择具有最长网络前缀的路由，因为网络前缀越长，其地址块就越小，因而路由就越具体。

​		CIDR查找路由表的方法:为了更加有效地查找最长前缀匹配，**通常将无分类编址的路由表存放在一种层次的数据结构中，然后自上而下地按层次进行查找**。这里最常用的数据结构就是**二叉线索**。

## 4.网际控制报文协议ICMP

​		ICMP是为了更有效地转发IP数据报和提高交付成功的机会。它封装在IP数据报中，作为IP层数据报的数据，不属于高层协议。

![image-20210314102435989](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314102435989.png)

ICMP 报文分为差错报告报文和询问报文。

![image-20210314102633889](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314102633889.png)

### （1）Ping

​		Ping是ICMP的一个重要应用，主要用来测试两台主机之间的连通性。Ping使用了ICMP回送请求和回送回答报文。**Ping是应用层直接使用网络层ICMP的一个例子**，它没有通过运输层的TCP或UDP。

​		Ping的原理是通过向目的主机发送ICMP Echo请求报文，目的主机收到之后会发送Echo回答报文。Ping会根据时间和成功响应的次数估算出数据报往返时间以及丢包率。

### （2）Traceroute

​		Traceroute（UNIX名称，Windows操作系统中这个命令是tracert ）是ICMP的另一个应用，用来跟踪一个分组从源点到终点的路径。

​		**Traceroute 发送的 IP 数据报封装的是无法交付的 UDP 用户数据报，并由目的主机发送终点不可达差错报告报文。**

- 源主机向目的主机发送一连串的 IP 数据报。第一个数据报 P1 的生存时间 TTL 设置为 1，当 P1 到达路径上的第一个路由器 R1 时，R1 收下它并把 TTL 减 1，此时 TTL 等于 0，R1 就把 P1 丢弃，并向源主机发送一个 ICMP 时间超过差错报告报文；
- 源主机接着发送第二个数据报 P2，并把 TTL 设置为 2。P2 先到达 R1，R1 收下后把 TTL 减 1 再转发给 R2，R2 收下后也把 TTL 减 1，由于此时 TTL 等于 0，R2 就丢弃 P2，并向源主机发送一个 ICMP 时间超过差错报文。
- 不断执行这样的步骤，直到最后一个数据报刚刚到达目的主机，主机不转发数据报，也不把 TTL 值减 1。但是因为数据报封装的是无法交付的 UDP，因此目的主机要向源主机发送 ICMP 终点不可达差错报告报文。
- 之后源主机知道了到达目的主机所经过的路由器 IP 地址以及到达每个路由器的往返时间。

## 5.路由选择协议

### （1）内部网关协议RIP

​		**RIP 是一种基于距离向量的路由选择协议。**距离是指跳数，直接相连的路由器跳数为 1。跳数最多为 15，超过 15 表示不可达。

​		RIP 按固定的时间间隔仅和相邻路由器交换自己的路由表，经过若干次交换之后，所有路由器最终会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器地址。

​		距离向量算法：

- 对地址为 X 的相邻路由器发来的 RIP 报文，先修改报文中的所有项目，把下一跳字段中的地址改为 X，并把所有的距离字段加 1；

- 对修改后的 RIP 报文中的每一个项目，进行以下步骤：

  若原来的路由表中没有目的网络 N，则把该项目添加到路由表中；（新项目）

  否则：若下一跳路由器地址是 X，则把收到的项目替换原来路由表中的项目；（以最新消息为准）

  否则：若收到的项目中的距离 d 小于路由表中的距离，则进行更新（例如原始路由表项为 Net2, 5, P，新表项为 Net2, 4, X，则更新，即距离大了不更新，变小才更新）；

  否则什么也不做。

- 若 3 分钟还没有收到相邻路由器的更新路由表，则把该相邻路由器标为不可达，即把距离置为 16。

​		RIP 协议实现简单，开销小。但是 RIP 能使用的最大距离为 15，限制了网络的规模。并且当网络出现故障时，要经过比较长的时间才能将此消息传送到所有路由器（**好消息传播的快、坏消息传播的慢**）。

![image-20210314162651050](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314162651050.png)

+ 这个时候R1是知道是无法到达的，则其到网1的距离为16，并且为直接交付。
+ 但是R2在收到R1报文之前，即在R2并不知道R1出故障时，发送了原来的报文，1 2 R1。
+ 于是，R1收到R2跟新报文后，误以为可以经过R2到网1，于是更新自己的路由表，1 3 R2，并且将次更新信息发送给R2.
+ 然后R2以后又跟新自己的路由表为1 4 R1, 30s后，又把这个信息发送给R1.
+ 就这样一直循环，直到R1和R2到网1的距离均增加到16时，R1和R2才知道原来网1是不可达的。

### （2）内部网关协议OSPF

​		开放最短路径优先OSPF，是为了克服RIP的缺点发开出来的。“最短路径优先”是因为使用了Dijkstra提出的最短路径算法SPF。

​		OSPF最主要的特征就是使用分布式的链路状态协议。

​		OSPF 具有以下特点：

- 向本自治系统中的所有路由器发送信息，这种方法是**洪泛法**。
- 发送的信息就是与相邻路由器的**链路状态**，链路状态包括与哪些路由器相连以及链路的度量，度量用费用、距离、时延、带宽等来表示。

+ **只有当链路状态发生变化时，路由器才会发送信息**。

​		**所有路由器最终都能建立一个链路状态数据库，即全网的拓扑结构图，并且是一致的。**相比于RIP，OSPF的更新过程收敛的快。	

​		若N个路由器连在一个以太网上，则每个路由要向其他（N-1）个路由器发送链路状态信息，因而共有$N(N-1)$个链路状态要在这个以太网上传送。

### （3）外部网关协议BGP

​		BGP即边界网关协议。

​		在不同的自治系统AS之间的路由选择很困难，这是因为：

+ 互联网规模太大；

+ 各个AS内部使用不同的路由选择协议，无法准确定义路径的度量
+ 各个AS之间的路由选择必须考虑有关策略。

![image-20210314164816586](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314164816586.png)

### （4）路由器的构成

​		路由器从功能上可以划分为：**路由选择和分组转发。**

​		分组转发结构由三个部分构成：交换结构、一组输入端口和一组输出端口。

![image-20210314165010654](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314165010654.png)

## 6.虚拟专用网VPN和网络地址转换NAT

### （1）虚拟专用网VPN

​		由于 IP 地址的紧缺，一个机构能申请到的 IP 地址数往往远小于本机构所拥有的主机数。并且一个机构并不需要把所有的主机接入到外部的互联网中，机构内的计算机可以使用仅在本机构有效的 IP 地址（专用地址）。

​		有三个专用地址块：

- 10.0.0.0 ~ 10.255.255.255（或记为10.0.0.0/8，它又称为24位块）
- 172.16.0.0 ~ 172.31.255.255（或记为172.16.0.0/12，它又称为20位块）
- 192.168.0.0 ~ 192.168.255.255（或记为192.168.0.0/16，它又称为16位块）

​		**VPN 使用公用的互联网作为本机构各专用网之间的通信载体。**有时一个很大的机构的许多部门分部的范围很广（例如，在世界各地），这些部门经常要互相交换信息，为了节约成本，就可以使用VPN。专用指机构内的主机只与本机构内的其它主机通信；“虚拟”指“好像是”，而实际上并不是，因为现在并没有真正使用通信专线，而VPN只是**效果上**和真正的专用网一样。它有经过公用的互联网。

​		下图中，场所 A 和 B 的通信经过互联网，如果场所 A 的主机 X 要和另一个场所 B 的主机 Y 通信，IP 数据报的源地址是 10.1.0.1，目的地址是 10.2.0.3。数据报先发送到与互联网相连的路由器 R1，R1 对内部数据进行加密，然后重新加上数据报的首部，源地址是路由器 R1 的全球地址 125.1.2.3，目的地址是路由器 R2 的全球地址 194.4.5.6。路由器 R2 收到数据报后将数据部分进行解密，恢复原来的数据报，此时目的地址为 10.2.0.3，就交付给 Y。

![image-20210314165954403](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314165954403.png)

### （2）网络地址转换NAT

​		专用网内部的主机使用本地 IP 地址（即仅在本专用网内使用的专用地址）。又想和互联网上的主机通信时，可以使用 NAT 来将本地 IP 转换为全球 IP。

​		在以前，NAT 将本地 IP 和全球 IP 一一对应，这种方式下拥有 n 个全球 IP 地址的专用网内最多可以同时有 n 台主机接入互联网。为了更有效地利用全球 IP 地址，现在常用的 NAT 转换表把**传输层的端口号**也用上了，使得**多个专用网内部的主机共用一个全球 IP 地址。**使用端口号的 NAT 也叫做网络地址与端口转换 NAPT。

![image-20210314171003741](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314171003741.png)

​		由图可知，专用网内主机192.168.0.3和192.168.0.4被转换为相同的全球IP地址（端口号相同为巧合，端口号仅在本主机中才有意义），但对源主机所采用的TCP端口号，则转换为不同的新的端口号。因此，当NAPT路由器收到从互联网发来的应答时，就可以从IP数据报的数据部分找出传输层的端口号，然后根据不同的目的端口号，从NAPT转换表中找到正确的目的主机。

# 四、传输层

## 1.概述

### （1）进程间的通信		

​		网络层只把分组发送到目的主机，但是真正通信的并不是主机而是主机中的进程。**传输层提供了进程间的逻辑通信**，传输层向高层用户屏蔽了下面网络层的核心细节，使应用程序看起来像是在两个传输层实体之间有一条端到端的逻辑通信信道。

### （2）UDP和TCP

+ 用户数据报协议 UDP（User Datagram Protocol）是无连接的，尽最大可能交付，没有拥塞控制，**面向报文（对于应用程序传下来的报文不合并也不拆分，只是添加 UDP 首部）**，支持一对一、一对多、多对一和多对多的交互通信。
+ 传输控制协议 TCP（Transmission Control Protocol）是面向连接的，提供可靠交付，有流量控制，拥塞控制，提供全双工通信，**面向字节流（把应用层传下来的报文看成字节流，把字节流组织成大小不等的数据块）**，每一条 TCP 连接只能是点对点的（一对一）。

### （3）运输层的端口

+ **复用**：应用层所有的应用进程都可以通过传输层再传送到IP层（网络层）。
+ **分用**：运输层从IP层收到发送给各应用进程的数据后，必须分别交付指明的各应用进程。

+ 硬件端口：不同硬件设备进行交互的接口。
+ 软件端口：应用层的各种协议进程与运输实体进行层间交互的一种地址。

​		端口号只具有本地意义，不同计算机中相同的端口号是没有关联的。由此可见，两个计算机中的进程要相互通信，不仅必须知道对方的IP地址（为了找到对方的计算机），还必须知道对方的端口号（为了找到对方计算机中的应用进程）。



![image-20210314175318994](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314175318994.png)

## 2.用户数据报协议UDP的首部格式

![image-20210314175428025](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314175428025.png)

+ UDP首部最小长度为8B。

+ 源端口：在对方需要回信时选用。

+ 目的端口：在终点交付报文时必须使用。

+ 长度：UDP长度，最小值为8（仅有首部）。

+ 检验和：检验UDP在传输中是否出错，有错就丢弃。

  ​	在计算检验和时，要在UDP之前**临时增加**12个字节的伪首部。

## 3.传输控制协议TCP的首部格式

![image-20210314180011899](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314180011899.png)

+ TCP首部最小长度为20B。

+ **序号**：占4B=32bit。序号范围是$[0,2^{32}-1]$，共$2^{32}$个序号。序号达到最大后，下一个序号就又回到0.用于对字节流进行编号，例如序号为 301，表示第一个字节的编号为 301，如果携带的数据长度为 100 字节，那么下一个报文段的序号应为 401。这个字段的名称也叫做“保温段序号”。

+ **确认号** ：占4B。期望收到的下一个报文段的序号。例如 B 正确收到 A 发送来的一个报文段，序号为 501，携带的数据长度为 200 字节，因此 B 期望下一个报文段的序号为 701，B 发送给 A 的确认报文段中确认号就为 701。
+ 数据偏移：占4位。它指出TCP报文段的数据起始处距离TCP报文段的起始处有多远。**这个字段实际上是指出TCP报文段的首部长度。**数据偏移的最大值是60B，这**也是TCP首部的最大长度（即选项长度不能超过40B）。**

+ **确认 ACK** ：仅当 ACK=1 时确认号字段有效，否则无效。TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 置 1。
+ **同步 SYN** ：在连接建立时用来同步序号。当 SYN=1，ACK=0 时表示这是一个连接请求报文段。若对方同意建立连接，则响应报文中 SYN=1，ACK=1。
+ **终止 FIN** ：用来释放一个连接，当 FIN=1 时，表示此报文段的发送方的数据已发送完毕，并要求释放连接。
+ **窗口** ：窗口值作为接收方让发送方设置其发送窗口的依据。之所以要有这个限制，是因为接收方的数据缓存空间是有限的。窗口字段明确指出了现在允许对方发送的数据量。窗口值经常在动态变化着。

## 4.TCP可靠传输

​		TCP 使用超时重传来实现可靠传输：如果一个已经发送的报文段在超时时间内没有收到确认，那么就重传这个报文段。

​		一个报文段从发送再到接收到确认所经过的时间称为往返时间 RTT，加权平均往返时间 $RTT_s$计算如下：

[![img](https://camo.githubusercontent.com/4b31b44c078c2a6fe1354e38006e624c3ae5af66ad3f982d3d73e220a120ab98/68747470733a2f2f6c617465782e636f6465636f67732e636f6d2f6769662e6c617465783f525454733d28312d61292a2852545473292b612a525454)](https://camo.githubusercontent.com/4b31b44c078c2a6fe1354e38006e624c3ae5af66ad3f982d3d73e220a120ab98/68747470733a2f2f6c617465782e636f6465636f67732e636f6d2f6769662e6c617465783f525454733d28312d61292a2852545473292b612a525454)	


​		其中，0 ≤ a ＜ 1，$RTT_s$随着 a 的增加更容易受到 RTT 的影响。

​		超时时间 RTO 应该略大于 $RTT_s$，TCP 使用的超时时间计算如下：

[![img](https://camo.githubusercontent.com/ae415414727a193c7c23b73199e5ca6c1caa84df9822bf02f8483f8a359605e0/68747470733a2f2f6c617465782e636f6465636f67732e636f6d2f6769662e6c617465783f52544f3d525454732b342a5254545f64)](https://camo.githubusercontent.com/ae415414727a193c7c23b73199e5ca6c1caa84df9822bf02f8483f8a359605e0/68747470733a2f2f6c617465782e636f6465636f67732e636f6d2f6769662e6c617465783f52544f3d525454732b342a5254545f64)


​		其中 $RTT_d$ 为偏差的加权平均值。

## 5.TCP流量控制

​		流量控制是为了控制发送方发送速率，保证接收方来得及接收。

​		接收方发送的确认报文中的窗口字段可以用来控制发送方窗口大小，从而影响发送方的发送速率。将窗口字段设置为 0，则发送方不能发送数据。

![image-20210314182228912](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314182228912.png)

​		数据链路层的窗口是固定的，传输层的窗口是可变的。

## 6.TCP拥塞控制

​		如果网络出现拥塞，分组将会丢失，此时发送方会继续重传，从而导致网络拥塞程度更高。**因此当出现拥塞时，应当控制发送方的速率。**这一点和流量控制很像，但是出发点不同。**流量控制是为了让接收方能来得及接收，而拥塞控制是为了降低整个网络的拥塞程度。**

​		TCP 主要通过四个算法来进行拥塞控制：慢开始、拥塞避免、快重传、快恢复。

​		发送方需要维护一个叫做拥塞窗口（cwnd）的状态变量。**拥塞窗口的大小取决于网络的拥塞程度，并且动态地在变化。发送方让自己的发送窗口等于拥塞窗口。**

​		为了便于讨论，做如下假设：

- 接收方有足够大的接收缓存，因此不会发生流量控制；
- 虽然 TCP 的窗口基于字节，但是这里设窗口的大小单位为报文段。

![image-20210314181501386](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314181501386.png)

### （1）慢开始与拥塞避免

​		发送的最初执行慢开始，令 cwnd = 1，发送方只能发送 1 个报文段；当收到确认后，将 cwnd 加倍，因此之后发送方能够发送的报文段数量为：2、4、8 ...

​		注意到慢开始每个轮次都将 cwnd 加倍，这样会让 cwnd 增长速度非常快，从而使得发送方发送的速度增长速度过快，网络拥塞的可能性也就更高。设置一个慢开始门限 ssthresh，当 cwnd >= ssthresh 时，进入拥塞避免，每个轮次只将 cwnd 加 1。

​		如果出现了超时，则令 ssthresh = cwnd / 2，然后重新执行慢开始。

### （2）快重传和快恢复

​		在接收方，要求每次接收到报文段都应该对最后一个已收到的有序报文段进行确认。例如已经接收到 M1 和 M2，此时收到 M4，应当发送对 M2 的确认。

​		在发送方，如果收到三个重复确认，那么可以知道下一个报文段丢失，此时执行快重传，立即重传下一个报文段。例如收到三个 M2，则 M3 丢失，立即重传 M3。

​		在这种情况下，只是丢失个别报文段，而不是网络拥塞。因此执行快恢复，令 ssthresh = cwnd / 2 ，cwnd = ssthresh，注意到此时直接进入拥塞避免。

​		慢开始和快恢复的快慢指的是 cwnd 的设定值，而不是 cwnd 的增长速率。慢开始 cwnd 设定为 1，而快恢复 cwnd 设定为 ssthresh。

![image-20210314181950693](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314181950693.png)

## 7.TCP三次握手

![image-20210314182606640](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314182606640.png)

​		假设 A 为客户端，B 为服务器端。

- 首先 B 处于 LISTEN（监听）状态，等待客户的连接请求。

- A 向 B 发送连接请求报文，SYN=1，ACK=0，选择一个初始的序号 x。

- B 收到连接请求报文，如果同意建立连接，则向 A 发送连接确认报文，SYN=1，ACK=1，确认号为 x+1，同时也选择一个初始的序号 y。

- A 收到 B 的连接确认报文后，还要向 B 发出确认，确认号为 y+1，序号为 x+1。

- B 收到 A 的确认后，连接建立。

  ​	注意：SYN报文段（即SYN=1的报文段）**不能携带数据**，但要**消耗掉一个序号**。

### 三次握手的原因

​		第三次握手是为了防止失效的连接请求到达服务器，让服务器错误打开连接。

​		客户端发送的连接请求如果在网络中滞留，那么就会隔很长一段时间才能收到服务器端发回的连接确认。客户端等待一个超时重传时间之后，就会重新请求连接。但是这个滞留的连接请求最后还是会到达服务器，如果不进行三次握手，那么服务器就会打开两个连接。如果有第三次握手，客户端会忽略服务器之后发送的对滞留连接请求的连接确认，不进行第三次握手，因此就不会再次打开连接。

## 8.TCP四次挥手

![image-20210314182845522](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314182845522.png)

​		以下描述不讨论序号和确认号，因为序号和确认号的规则比较简单。并且不讨论 ACK，因为 ACK 在连接建立之后都为 1。

- A 发送连接释放报文，FIN=1。
- B 收到之后发出确认，此时 TCP 属于半关闭状态，B 能向 A 发送数据但是 A 不能向 B 发送数据。
- 当 B 不再需要连接时，发送连接释放报文，FIN=1。
- A 收到后发出确认，进入 TIME-WAIT 状态，等待 2 MSL（最大报文存活时间）后释放连接。
- B 收到 A 的确认后释放连接。

### 四次挥手的原因

​		客户端发送了 FIN 连接释放报文之后，服务器收到了这个报文，就进入了 CLOSE-WAIT 状态。这个状态是为了让服务器端发送还未传送完毕的数据，传送完毕之后，服务器会发送 FIN 连接释放报文。

### TIME_WAIT

​		客户端接收到服务器端的 FIN 报文后进入此状态，此时并不是直接进入 CLOSED 状态，还需要等待一个时间计时器设置的时间 2MSL（MSL=2min，是最大报文段寿命）。这么做有两个理由：

- **确保最后一个确认报文能够到达。**如果 B 没收到 A 发送来的确认报文，那么就会重新发送连接释放请求报文，A 等待一段时间就是为了处理这种情况的发生。
- 等待一段时间是为了**让本连接持续时间内所产生的所有报文都从网络中消失**，使得下一个新的连接不会出现旧的连接请求报文。

# 五、应用层

## 1.域名系统DNS

### （1）域名系统概述

​		域名系统DNS是互联网使用的命名系统，用来把便于人们使用的机器名字转换为IP地址。**机器在处理IP数据报时使用IP地址而不是域名的原因是因为IP地址长度固定，而域名长度不固定，机器处理起来比较困难。**

​		DNS 是一个分布式数据库，提供了主机名和 IP 地址之间相互转换的服务。这里的分布式数据库是指，每个站点只保留它自己的那部分数据。

### （2）互联网的域名结构

​		域名具有层次结构，从上到下依次为：根域名、顶级域名、二级域名。

![image-20210314194611188](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314194611188.png)

​		**DNS 可以使用 UDP 或者 TCP 进行传输，使用的端口号都为 53**。大多数情况下 DNS 使用 UDP 进行传输，这就要求域名解析器和域名服务器都必须自己处理超时和重传从而保证可靠性。在两种情况下会使用 TCP 进行传输：

- 如果返回的响应超过的 512 字节（**UDP 最大只支持 512 字节的数据）**。
- 区域传送（区域传送是主域名服务器向辅助域名服务器传送变化的那部分数据）。

![image-20210314194736537](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314194736537.png)

​		为了提高DNS的查询效率。并减少因特网上的DNS查询报文数量，在域名服务器中广泛的使用了**高速缓存**。当一个DNS服务器接收到DNS查询结果时，它能将该DNS信息缓存在高速缓存中。

​		如果一台主机通过两块网卡连接到两个网络(如服务器双线接入)，那么就具有两个IP地址,每个网卡对应一个MAC地址，显然这**两个IP地址可以映射到同一个域名上，一个IP地址也可以映射到多个域名上。**此外，多台主机也可以映射到同一个域名上（如负载均衡)，一台主机也可以映射到多个域名上（如虚拟主机)。

## 2.文件传送协议FTP

### （1）FTP的基本工作原理

​		FTP 使用 TCP 进行连接，它需要两个连接来传送一个文件：

- 控制连接：服务器打开**端口号 21** 等待客户端的连接，客户端主动建立连接后，使用这个连接将客户端的命令传送给服务器，并传回服务器的应答。

- 数据连接：用来传送一个文件数据。

  根据数据连接是否是服务器端主动建立，FTP 有主动和被动两种模式：

- 主动模式：服务器端主动建立数据连接，其中服务器端的端口号为 20，客户端的端口号随机，但是必须大于 1024，因为 0~1023 是熟知端口号。

![image-20210314200102777](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314200102777.png)

- 被动模式：客户端主动建立数据连接，其中客户端的端口号由客户端自己指定，服务器端的端口号随机。

![image-20210314200124758](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314200124758.png)

​		主动模式要求客户端开放端口号给服务器端，需要去配置客户端的防火墙。被动模式只需要服务器端开放端口号即可，无需客户端配置防火墙。但是被动模式会导致服务器端的安全性减弱，因为开放了过多的端口号。

### （2）网络文件系统NFS

​		FTP并非对所有的数据传输都是最佳的。例如，计算机A上运行的应用程序要在远地计算机B的一个很大的文件末尾添加一行信息。若使用FTP，则应现将此文件从计算机B传送到计算机A，填上这一行信息后再传送回去，这就耗费了大量的时间。

​		网络文件系统NFS允许应用进程打开一个远地文件，并能在该文件的某一个特定的位置上开始读写数据。这样在网络上上传送的只是少量的修改数据。

### （3）简单文件传送协议TFTP

​		TFTP使用UDP数据报，只支持文件传输而不支持交互。

## 3.远程终端协议TELNET

​		TELNET 用于登录到远程主机上，并且远程主机上的输出也会返回。

​		TELNET 可以适应许多计算机和操作系统的差异，例如不同操作系统系统的换行符定义。



## 4.万维网WWW

### （1）万维网概述

​		万维网是一个大规模的、联机式的信息储藏所，是一个有许多互相链接的超文本组成的系统，通过互联网访问。因此超文本是万维网的基础。

### （2）统一资源定位符URL

​		统一资源定位符URL是用来表示从互联网上得到的资源位置和访问这些资源的方法。

​		URL的一般形式由以下四个部分组成：

<center><协议>://<主机>:<端口>/<路径>
</center>

​		这里的<协议>就是指出使用什么协议来获取该万维网文档。现在最常用的协议就是http，其次是ftp。

### （3）超文本传送协议HTTP

​		超文本传输协议HTTP是一种用于分布式、协作式和超媒体信息系统的**应用层协议**。HTTP 是万维网的数据通信的基础。

​		HTTP协议使用了面向连接的TCP作为运输层协议，保证了数据的可靠传输，但**HTTP协议本身是无连接的。即通信双方在交换HTTP报文之前不需要先建立HTTP链接**。

​		HTTP协议是无状态的，也就是说同一个客户第二次访问同一个服务器上的页面时，服务器的响应与第一次被访问时的相同，因为服务器并不记得这个客户，也不记得该客户访问了多少次。

## 5.动态主机配置协议DHCP

DHCP (Dynamic Host Configuration Protocol) 提供了即插即用的连网方式，用户不再需要手动配置 IP 地址等信息。

**DHCP 配置的内容不仅是 IP 地址，还包括子网掩码、网关 IP 地址。**

DHCP 工作过程如下：

1. 客户端发送 Discover 报文，该报文的目的地址为 255.255.255.255:67，源地址为 0.0.0.0:68，被放入 UDP 中，该报文被广播到同一个子网的所有主机上。如果客户端和 DHCP 服务器不在同一个子网，就需要使用中继代理。

2. DHCP 服务器收到 Discover 报文之后，发送 Offer 报文给客户端，该报文包含了客户端所需要的信息。因为客户端可能收到多个 DHCP 服务器提供的信息，因此客户端需要进行选择。

3. 如果客户端选择了某个 DHCP 服务器提供的信息，那么就发送 Request 报文给该 DHCP 服务器。

4. DHCP 服务器发送 Ack 报文，表示客户端此时可以使用提供给它的信息。

   ![image-20210314202503058](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314202503058.png)

​	

​		**DHCP客户使用的UDP端口是68，而DHCP服务器使用的UDP端口是67.**

​		DHCP主要有两个用途：

+ 用于内部网络或网络服务供应商**自动分配 IP 地址**给用户

- 用于内部网络管理员作为**对所有电脑作中央管理的手段**

## 6.电子邮件

### （1）简单邮件传输协议SMTP

​		SMTP 只能发送 ASCII 码，而MIME（多用途网络邮件扩充） 可以发送二进制文件。MIME 并没有改动或者取代 SMTP，而是增加邮件主体的结构，定义了非 ASCII 码的编码规则。![image-20210314203252887](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314203252887.png)



### （2）邮件读取协议POP3和IMAP

​		POP3 的特点是只要用户从服务器上读取了邮件，服务器就把该邮件删除，但最新版本的 POP3 可以不删除邮件。这分别对应了POP的“下载并删除”与“下载并保留”两种工作方式。

​		IMAP 协议中客户端和服务器上的邮件保持同步，如果不手动删除邮件，那么服务器上的邮件也不会被删除。IMAP 这种做法可以让用户随时随地去访问服务器上的邮件。IMAP的另一特性是允许用户代理**只获取报文的某些部分**。

## 7.简单网络管理协议SNMP

​		SNMP构成了互联网工程工作小组（IETF，Internet Engineering Task Force）定义的 Internet 协议族的一部分。该协议能够支持网络管理系统，用以监测连接到网络上的设备是否有任何引起管理上关注的情况。

## 8.常用端口

![image-20210314204008211](C:\Users\Ursnus\AppData\Roaming\Typora\typora-user-images\image-20210314204008211.png)

## 9.Web页面请求过程

### 1. DHCP 配置主机信息

- 假设主机最开始没有 IP 地址以及其它信息，那么就需要先使用 DHCP 来获取。
- 主机生成一个 DHCP 请求报文，并将这个报文放入具有目的端口 67 和源端口 68 的 UDP 报文段中。
- 该报文段则被放入在一个具有广播 IP 目的地址(255.255.255.255) 和源 IP 地址（0.0.0.0）的 IP 数据报中。
- 该数据报则被放置在 MAC 帧中，该帧具有目的地址 FF:FF:FF:FF:FF:FF，将广播到与交换机连接的所有设备。
- 连接在交换机的 DHCP 服务器收到广播帧之后，不断地向上分解得到 IP 数据报、UDP 报文段、DHCP 请求报文，之后生成 DHCP ACK 报文，该报文包含以下信息：**IP 地址、DNS 服务器的 IP 地址、默认网关路由器的 IP 地址和子网掩码**。该报文被放入 UDP 报文段中，UDP 报文段有被放入 IP 数据报中，最后放入 MAC 帧中。
- 该帧的目的地址是请求主机的 MAC 地址，因为交换机具有自学习能力，之前主机发送了广播帧之后就记录了 MAC 地址到其转发接口的交换表项，因此现在交换机就可以直接知道应该向哪个接口发送该帧。
- 主机收到该帧后，不断分解得到 DHCP 报文。之后就配置它的 IP 地址、子网掩码和 DNS 服务器的 IP 地址，并在其 IP 转发表中安装默认网关。

### 2. ARP 解析 MAC 地址

- 主机通过浏览器生成一个 TCP 套接字，套接字向 HTTP 服务器发送 HTTP 请求。为了生成该套接字，主机需要知道网站的域名对应的 IP 地址。
- 主机生成一个 DNS 查询报文，该报文具有 53 号端口，因为 DNS 服务器的端口号是 53。
- 该 DNS 查询报文被放入目的地址为 DNS 服务器 IP 地址的 IP 数据报中。
- 该 IP 数据报被放入一个以太网帧中，该帧将发送到网关路由器。
- DHCP 过程只知道网关路由器的 IP 地址，为了获取网关路由器的 MAC 地址，需要使用 ARP 协议。
- 主机生成一个包含目的地址为网关路由器 IP 地址的 ARP 查询报文，将该 ARP 查询报文放入一个具有广播目的地址（FF:FF:FF:FF:FF:FF）的以太网帧中，并向交换机发送该以太网帧，交换机将该帧转发给所有的连接设备，包括网关路由器。
- 网关路由器接收到该帧后，不断向上分解得到 ARP 报文，发现其中的 IP 地址与其接口的 IP 地址匹配，因此就发送一个 ARP 回答报文，包含了它的 MAC 地址，发回给主机。

### 3. DNS 解析域名

- 知道了网关路由器的 MAC 地址之后，就可以继续 DNS 的解析过程了。
- 网关路由器接收到包含 DNS 查询报文的以太网帧后，抽取出 IP 数据报，并根据转发表决定该 IP 数据报应该转发的路由器。
- 因为路由器具有内部网关协议（RIP、OSPF）和外部网关协议（BGP）这两种路由选择协议，因此路由表中已经配置了网关路由器到达 DNS 服务器的路由表项。
- 到达 DNS 服务器之后，DNS 服务器抽取出 DNS 查询报文，并在 DNS 数据库中查找待解析的域名。
- 找到 DNS 记录之后，发送 DNS 回答报文，将该回答报文放入 UDP 报文段中，然后放入 IP 数据报中，通过路由器反向转发回网关路由器，并经过以太网交换机到达主机。

### 4. HTTP 请求页面

- 有了 HTTP 服务器的 IP 地址之后，主机就能够生成 TCP 套接字，该套接字将用于向 Web 服务器发送 HTTP GET 报文。
- 在生成 TCP 套接字之前，必须先与 HTTP 服务器进行三次握手来建立连接。生成一个具有目的端口 80 的 TCP SYN 报文段，并向 HTTP 服务器发送该报文段。
- HTTP 服务器收到该报文段之后，生成 TCP SYN ACK 报文段，发回给主机。
- 连接建立之后，浏览器生成 HTTP GET 报文，并交付给 HTTP 服务器。
- HTTP 服务器从 TCP 套接字读取 HTTP GET 报文，生成一个 HTTP 响应报文，将 Web 页面内容放入报文主体中，发回给主机。
- 浏览器收到 HTTP 响应报文后，抽取出 Web 页面内容，之后进行渲染，显示 Web 页面。

